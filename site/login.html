<!---------------------------------------------------------------------
--
-- index.html
-- Index file for Amazon DynamoDB example.
-- Copyright (c) 2016 Bill St. Clair <billstclair@gmail.com>
-- Some rights reserved.
-- Distributed under the MIT License
-- See LICENSE.txt
--
----------------------------------------------------------------------->

<html>
<head>
<title>DynamoDB via Amazon SDK in the Browser</title>
<script type='text/javascript' src='https://sdk.amazonaws.com/js/aws-sdk-2.6.12.min.js'></script>
<script type='text/javascript' src='dynamodb.js'></script>
</head>
<body>

<script type="text/javascript">

// This should be passed in from the Elm code, or something
var clientId = 'amzn1.application-oa2-client.51c688dac8f845818a4003f432d4d520';

// From http://login.amazon.com/website
window.onAmazonLoginReady = function() {
  amazon.Login.setClientId(clientId);
};

// Modified from http://login.amazon.com/website
// Expects to be called with document as arg
function installLoginScript (d) {
  var a = d.createElement('script');
  a.type = 'text/javascript';
  a.async = true;
  a.id = 'amazon-login-sdk';
  a.src = 'https://api-cdn.amazon.com/sdk/login1.js';
  d.getElementById('amazon-root').appendChild(a);
};

function addProperty (name, obj, arr) {
  var val = obj[name];
  if (!(val === undefined)) {
    arr.push([name, String(val)])
  }
  return arr;
}

function addProperties (names, obj, arr) {
  for (idx in names) {
    var name = names[idx];
    arr = addProperty(name, obj, arr);
  }
  return arr;
}

var loginCompleteResponse = null;

function loginComplete (response) {
  loginCompleteResponse = response;
  var res = [];
  var err = response.error;
  if (err) {
    res = addProperties(["error", "error_description", "error_uri"],
                        response,
                        res);
  } else {
    var accessToken = response.access_token;
    // http://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-browser-credentials-federated-id.html
    AWS.config.credentials.params.WebIdentityToken = accessToken;
    res = addProperties(["state", "access_token",
                         "token_type", "expires_in", "scope"],
                        response,
                        res)
  }
  app.ports.loginResponse.send(res);
}

//  document.getElementById('LoginWithAmazon').onclick = function() {
function login (state) {
  options = { scope : 'profile', state : state };
  amazon.Login.authorize(options, loginComplete);
};

function getDynamoDbProperties (db) {
  var res = getProperties("");
  if (!res) res = [];  
  var api = db.api;
  return addProperties(["abbreviation", "apiVersion", "protocol"],
                       api,
                       res);
}

// These also need to be settable parameters
var dynamoTable = "haslists";
var dynamoApp = "kakuro";

function debugCallback(err, data) {
  if (err) console.log(err, err.stack);
  else console.log(data);
}

// DynamoDB access functions
function updateItem(keys, value, callback) {
  if (callback === undefined) {
    callback = debugCallback;
  }
  var params = {
    Key: {
      user: {
        S: keys.user
      },
      appkey: {
        S: dynamoApp + ":" + keys.key
      }
    },
    TableName: dynamoTable,
    AttributeUpdates: {
      value: {
        Action : 'PUT',
        Value: {
          S: value
        }
      }
    }
  }
  dynamodb.updateItem(params, callback);
}

function getItem(keys, callback) {
  if (callback === undefined) {
    callback = debugCallback;
  }
  var params = {
    Key: {
      user: {
        S: keys.user
      },
      appkey: {
        S: dynamoApp + ":" + keys.key
      }
    },
    TableName: dynamoTable,
    AttributesToGet: [
      'value'
      ]
  }
  dynamodb.getItem(params, callback);
}

function deleteItem(keys, callback) {
  if (callback === undefined) {
    callback = debugCallback;
  }
  var params = {
    Key: {
      user: {
        S: keys.user
      },
      appkey: {
        S: dynamoApp + ":" + keys.key
      }
    },
    TableName: dynamoTable,
  }
  dynamodb.deleteItem(params, callback);
}

function scanKeys(user, callback) {
  if (callback === undefined) {
    callback = debugCallback;
  }
  var params = {
    TableName: dynamoTable,
    AttributesToGet: [
      'appkey'
      ],
    ScanFilter: {
      appkey: {
        ComparisonOperator: 'BEGINS_WITH',
        AttributeValueList: [
          {
            S: dynamoApp + ':'
          }
        ]
      }
    }
  }
  dynamodb.scan(params, callback);
}


// Roles created here:
// https://console.aws.amazon.com/iam/home?#roles
// The RoleArn should be a parameter.
AWS.config.credentials = new AWS.WebIdentityCredentials({
  RoleArn: 'arn:aws:iam::575107064159:role/haslists-wif',
  ProviderId: 'www.amazon.com',
});

// This should be a parameter.
AWS.config.update({region: 'us-east-1'});

// Create a service object
var dynamodb = new AWS.DynamoDB();
var properties = getDynamoDbProperties(dynamodb);

// Start the Elm app
var app = Elm.DynamoDB.fullscreen(properties);

// Elm Ports
app.ports.installLoginScript.subscribe(function(ignore) {
  installLoginScript(document);
});

app.ports.login.subscribe(function(state) {
  login(state);
});

app.ports.logout.subscribe(function(ignore) {
  amazon.Login.logout();
});

function storageName(name) {
  return "dynamodb_" + name;
}

function putProperties(name, properties) {
  json = JSON.stringify(properties);
  localStorage.setItem(storageName(name), json);
}

function getProperties(name) {
  json = localStorage.getItem(storageName(name));
  properties = json ? JSON.parse(json) : null;
  return properties;
}

app.ports.saveProperties.subscribe(function(pair) {
  putProperties(pair[0], pair[1]);
});

app.ports.requestProperties.subscribe(function(name) {
  app.ports.receiveProperties.send(getProperties(name));
});  

</script>

</body>
</html>

